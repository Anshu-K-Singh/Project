{% extends 'surveyapp/home.html' %}
{% load static %}

<div class="main-content h-screen overflow-auto bg-gray-100 p-6">
    {% block content %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Total Surveys Card -->
        <div class="bg-white rounded-lg shadow-md p-6 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Surveys</h3>
                <p class="text-3xl font-bold text-blue-600">{{ total_surveys }}</p>
            </div>
            <div class="bg-blue-100 rounded-full p-4">
                <i class="fa fa-clipboard fa-2x text-blue-600"></i>
            </div>
        </div>

        <!-- Total Responses Card -->
        <div class="bg-white rounded-lg shadow-md p-6 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Responses</h3>
                <p class="text-3xl font-bold text-purple-600">{{ total_responses }}</p>
            </div>
            <div class="bg-purple-100 rounded-full p-4">
                <i class="fa fa-users fa-2x text-purple-600"></i>
            </div>
        </div>

        <!-- Respondent Insights Card -->
        <div class="bg-white rounded-lg shadow-md p-6 col-span-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Respondent Insights</h2>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button 
                        type="button" 
                        hx-get="{% url 'load_chart' %}?chart=gender"
                        hx-target="#chart-container"
                        class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700">
                        Gender
                    </button>
                    <button 
                        type="button" 
                        hx-get="{% url 'load_chart' %}?chart=education"
                        hx-target="#chart-container"
                        class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700">
                        Education
                    </button>
                    <button 
                        type="button" 
                        hx-get="{% url 'load_chart' %}?chart=age"
                        hx-target="#chart-container"
                        class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700">
                        Age
                    </button>
                </div>
            </div>

            <!-- Chart Container with Explicit Scrolling -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div id="chart-container-wrapper" class="w-full overflow-auto" style="max-height: 500px;">
                    <div id="chart-container" class="w-full min-h-[450px]">
                        {{ gender_chart|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plotly Scroll Enhancement Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainContent = document.querySelector('.main-content');
            const chartContainer = document.getElementById('chart-container');
            const chartWrapper = document.getElementById('chart-container-wrapper');
            
            // Enable full page scrolling
            if (mainContent) {
                mainContent.style.overflowY = 'auto';
                mainContent.style.height = '100vh';
            }

            function enableChartScroll() {
                if (chartContainer && chartWrapper) {
                    // Ensure Plotly chart can be scrolled within its container
                    chartContainer.style.overflow = 'auto';
                    chartWrapper.style.overflow = 'auto';
                    
                    // Add wheel event listener to prevent page scroll
                    chartWrapper.addEventListener('wheel', function(e) {
                        const isAtTop = this.scrollTop === 0;
                        const isAtBottom = (this.scrollTop + this.clientHeight) >= this.scrollHeight;
                        
                        // Only prevent default if fully scrolled or at start
                        if ((e.deltaY < 0 && isAtTop) || (e.deltaY > 0 && isAtBottom)) {
                            e.preventDefault();
                        }
                        
                        // Stop propagation to prevent page scroll
                        e.stopPropagation();
                    }, { passive: false });
                }
            }

            // Initial setup
            enableChartScroll();

            // Re-enable scroll after HTMX loads new content
            document.body.addEventListener('htmx:afterOnLoad', function() {
                enableChartScroll();
            });
        });
    </script>
    <script>
    fetch('/debug-chart-data/')
    .then(response => response.json())
    .then(data => {
        console.log("Received Data:", data);

        data.forEach(entry => {
            console.log(Gender: ${entry.gender}, Count: ${entry.count});
        });

        // Now, pass it to the chart
        generatePieChart(data);
    });
    </script>

    <!-- Include Plotly and HTMX -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    {% endblock %}
</div>